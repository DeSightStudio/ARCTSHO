{% comment %}
  Dieses Snippet enthält alle Pop-Ups und lädt die Inhalte direkt aus den Theme-Einstellungen
{% endcomment %}

<div class="popup-container">
  {% comment %} Certificate of Origin Pop-Up {% endcomment %}
  {% if settings.popup_certificate_origin_enable %}
    <div class="modal micromodal-slide" id="modal-certificate-origin" aria-hidden="true">
      <div class="modal__overlay" tabindex="-1" data-custom-close>
        <div class="modal__container" role="dialog" aria-modal="true" aria-labelledby="modal-certificate-origin-title">
          <button class="modal__close" aria-label="Close modal" data-custom-close>x</button>
          <header class="modal__header">
            <h2 class="modal__title" id="modal-certificate-origin-title">
              {{ settings.popup_certificate_origin_headline }}
            </h2>
            <h3>
              {{ settings.popup_certificate_origin_abbr }}
            </h3>
          </header>
          <main class="modal__content" id="modal-certificate-origin-content">
            <div class="modal__text">
              {{ settings.popup_certificate_origin_text }}
            </div>
            {% if settings.popup_certificate_origin_more_info != blank %}
              <div class="modal__more-info">
                <div class="modal__more-info-content">
                  {{ settings.popup_certificate_origin_more_info }}
                </div>
              </div>
            {% endif %}
          </main>
        </div>
      </div>
    </div>
  {% endif %}

  {% comment %} Clearance Certificate Pop-Up {% endcomment %}
  {% if settings.popup_clearance_certificate_enable %}
    <div class="modal micromodal-slide" id="modal-clearance-certificate" aria-hidden="true">
      <div class="modal__overlay" tabindex="-1" data-custom-close>
        <div
          class="modal__container"
          role="dialog"
          aria-modal="true"
          aria-labelledby="modal-clearance-certificate-title"
        >
          <button class="modal__close" aria-label="Close modal" data-custom-close>x</button>
          <header class="modal__header">
            <h2 class="modal__title" id="modal-clearance-certificate-title">
              {{ settings.popup_clearance_certificate_headline }}
            </h2>
            <h3>
              {{ settings.popup_clearance_certificate_abbr }}
            </h3>
          </header>
          <main class="modal__content" id="modal-clearance-certificate-content">
            <div class="modal__text">
              {{ settings.popup_clearance_certificate_text }}
            </div>
            {% if settings.popup_clearance_certificate_more_info != blank %}
              <div class="modal__more-info">
                <div class="modal__more-info-content">
                  {{ settings.popup_clearance_certificate_more_info }}
                </div>
              </div>
            {% endif %}
          </main>
        </div>
      </div>
    </div>
  {% endif %}

  {% comment %} VAT | UID | TVA Pop-Up {% endcomment %}
  {% if settings.popup_vat_uid_tva_enable %}
    <div class="modal micromodal-slide" id="modal-vat-uid-tva" aria-hidden="true">
      <div class="modal__overlay" tabindex="-1" data-custom-close>
        <div
          class="modal__container modal__container--wide"
          role="dialog"
          aria-modal="true"
          aria-labelledby="modal-vat-uid-tva-title"
        >
          <button class="modal__close" aria-label="Close modal" data-custom-close>x</button>
          <header class="modal__header">
            <h2 class="modal__title" id="modal-vat-uid-tva-title">
              {{ settings.popup_vat_uid_tva_headline }}
            </h2>
            <h3>
              {{ settings.popup_vat_uid_tva_abbr }}
            </h3>
          </header>
          <main class="modal__content" id="modal-vat-uid-tva-content">
            <div class="modal__columns">
              <div class="modal__column">
                {{ settings.popup_vat_uid_tva_text_col1 }}
              </div>
              <div class="modal__column">
                {{ settings.popup_vat_uid_tva_text_col2 }}
              </div>
              <div class="modal__column">
                {{ settings.popup_vat_uid_tva_text_col3 }}
              </div>
            </div>
            {% if settings.popup_vat_uid_tva_more_info != blank %}
              <div class="modal__more-info">
                <div class="modal__more-info-content">
                  {{ settings.popup_vat_uid_tva_more_info }}
                </div>
              </div>
            {% endif %}
          </main>
        </div>
      </div>
    </div>
  {% endif %}

  {% comment %} VAT ID Cart Form Pop-Up {% endcomment %}
  {% if settings.cart_popup_vat_id_enable %}
    <div class="modal micromodal-slide" id="modal-cart-vat-id" aria-hidden="true">
      <div class="modal__overlay" tabindex="-1" data-custom-close>
        <div
          class="modal__container"
          role="dialog"
          aria-modal="true"
          aria-labelledby="modal-cart-vat-id-title"
        >
          <button class="modal__close" aria-label="Close modal" data-custom-close>x</button>
          <header class="modal__header">
            <h2 class="modal__title" id="modal-cart-vat-id-title">
              {{ settings.cart_popup_vat_id_headline }}
            </h2>
          </header>
          <main class="modal__content" id="modal-cart-vat-id-content">
            <div class="modal__text">
              {{ settings.cart_popup_vat_id_text }}
            </div>

            <div id="vatIdCartFormContainer">
              {%- form 'contact', id: 'vatIdCartForm', class: 'vat-id-form' -%}
                {% if form.posted_successfully? %}
                  <div class="form-success">
                    {{ settings.cart_popup_vat_id_success_message }}
                  </div>
                  <script>
                    // Sofortiges Leeren des Warenkorbs bei erfolgreicher Formularübermittlung
                    (function () {
                      // Prüfen, ob wir durch URL-Parameter erkennen können, dass das Formular erfolgreich gesendet wurde
                      const urlParams = new URLSearchParams(window.location.search);
                      const isFormSuccess = urlParams.get('form_submission') === 'success';

                      // Einmaliger Aufruf zur Vermeidung von Schleifen
                      if (!sessionStorage.getItem('vatIdFormProcessed')) {
                        console.log('VAT-ID Formular erfolgreich gesendet - leere Warenkorb');

                        // Markieren, dass wir diesen Prozess bereits durchgeführt haben
                        sessionStorage.setItem('vatIdFormProcessed', 'true');

                        // Warenkorb leeren
                        fetch('/cart/clear.js', {
                          method: 'POST',
                          headers: {
                            'Content-Type': 'application/json',
                          },
                        })
                          .then((response) => response.json())
                          .then((data) => {
                            console.log('Warenkorb erfolgreich geleert:', data);

                            // Schließen des Modals nach kurzer Verzögerung
                            setTimeout(function () {
                              if (typeof MicroModal !== 'undefined') {
                                MicroModal.close('modal-cart-vat-id');
                              }
                            }, 2000);
                          })
                          .catch((error) => {
                            console.error('Fehler beim Leeren des Warenkorbs:', error);
                          });
                      }
                    })();
                  </script>
                {% elsif form.errors %}
                  <div class="form-error">
                    <h2>
                      {{ 'templates.contact.form.error_heading' | t }}
                    </h2>
                    <ul>
                      {% for field in form.errors %}
                        <li>
                          <a href="#ContactForm-{{ field }}">
                            {{ form.errors.translated_fields[field] | capitalize }}
                            {{ form.errors.messages[field] }}
                          </a>
                        </li>
                      {% endfor %}
                    </ul>
                  </div>
                {% endif %}

                <input type="hidden" name="contact[form_type]" value="VAT ID Form">

                {% comment %} Produktdaten aus dem Warenkorb hinzufügen {% endcomment %}
                <input
                  type="hidden"
                  id="vatIdForm-cart_items"
                  name="contact[cart_items]"
                  value="{% for item in cart.items %}{{ item.product.title }} ({{ item.variant.title }}) - {{ item.quantity }}x - {{ item.final_price | money }}{% unless forloop.last %} | {% endunless %}{% endfor %}"
                >
                <input
                  type="hidden"
                  id="vatIdForm-cart_total"
                  name="contact[cart_total]"
                  value="{{ cart.total_price | money }}"
                >

                <div class="cart-items-summary" id="vatIdForm-cart-summary">
                  <h3>{{ 'sections.cart.caption' | t }}</h3>
                  <table class="cart-items-table">
                    <thead>
                      <tr>
                        <th>{{ 'sections.cart.headings.product' | t }}</th>
                        <th>{{ 'sections.cart.headings.quantity' | t }}</th>
                        <th>{{ 'sections.cart.headings.price' | t }}</th>
                      </tr>
                    </thead>
                    <tbody id="vatIdForm-cart-items">
                      {% for item in cart.items %}
                        <tr>
                          <td>
                            <div class="cart-item-name">{{ item.product.title }}</div>
                            {% if item.variant.title != 'Default Title' %}
                              <div class="cart-item-variant">{{ item.variant.title }}</div>
                            {% endif %}
                          </td>
                          <td>{{ item.quantity }}</td>
                          <td>{{ item.final_line_price | money }}</td>
                        </tr>
                      {% endfor %}
                    </tbody>
                    <tfoot>
                      <tr>
                        <td colspan="2">{{ 'sections.cart.estimated_total' | t }}:</td>
                        <td id="vatIdForm-cart-total">
                          <strong>{{ cart.total_price | money }}</strong>
                        </td>
                      </tr>
                    </tfoot>
                  </table>
                </div>

                <div class="form-field-group">
                  <div class="form-field">
                    <label for="ContactForm-firstName">
                      {{- 'customer.vat_form.first_name' | t }}
                      <span aria-hidden="true">*</span></label
                    >
                    <input
                      type="text"
                      id="ContactForm-firstName"
                      name="contact[first_name]"
                      value="{% if form.first_name %}{{ form.first_name }}{% endif %}"
                      autocomplete="given-name"
                      required
                    >
                  </div>
                  <div class="form-field">
                    <label for="ContactForm-lastName">
                      {{- 'customer.vat_form.last_name' | t }}
                      <span aria-hidden="true">*</span></label
                    >
                    <input
                      type="text"
                      id="ContactForm-lastName"
                      name="contact[last_name]"
                      value="{% if form.last_name %}{{ form.last_name }}{% endif %}"
                      autocomplete="family-name"
                      required
                    >
                  </div>
                </div>

                <div class="form-field-group">
                  <div class="form-field">
                    <label for="ContactForm-email">
                      {{- 'customer.vat_form.email' | t }}
                      <span aria-hidden="true">*</span></label
                    >
                    <input
                      type="email"
                      id="ContactForm-email"
                      name="contact[email]"
                      value="{% if form.email %}{{ form.email }}{% endif %}"
                      autocomplete="email"
                      spellcheck="false"
                      autocapitalize="off"
                      required
                    >
                  </div>
                  <div class="form-field">
                    <label for="ContactForm-phone">
                      {{- 'customer.vat_form.phone' | t }}
                      <span aria-hidden="true">*</span></label
                    >
                    <input
                      type="tel"
                      id="ContactForm-phone"
                      name="contact[phone]"
                      value="{% if form.phone %}{{ form.phone }}{% endif %}"
                      autocomplete="tel"
                      required
                    >
                  </div>
                </div>

                <div class="form-field">
                  <label for="ContactForm-company">
                    {{- 'customer.vat_form.company' | t }}
                    <span aria-hidden="true">*</span></label
                  >
                  <input
                    type="text"
                    id="ContactForm-company"
                    name="contact[company]"
                    value="{% if form.company %}{{ form.company }}{% endif %}"
                    required
                  >
                </div>

                <div class="form-field">
                  <label for="ContactForm-address">
                    {{- 'customer.vat_form.address' | t }}
                    <span aria-hidden="true">*</span></label
                  >
                  <input
                    type="text"
                    id="ContactForm-address"
                    name="contact[address]"
                    value="{% if form.address %}{{ form.address }}{% endif %}"
                    required
                  >
                </div>

                <div class="form-field-group">
                  <div class="form-field">
                    <label for="ContactForm-postalCode">
                      {{- 'customer.vat_form.postal_code' | t }}
                      <span aria-hidden="true">*</span></label
                    >
                    <input
                      type="text"
                      id="ContactForm-postalCode"
                      name="contact[postal_code]"
                      value="{% if form.postal_code %}{{ form.postal_code }}{% endif %}"
                      required
                    >
                  </div>
                  <div class="form-field">
                    <label for="ContactForm-city">
                      {{- 'customer.vat_form.city' | t }}
                      <span aria-hidden="true">*</span></label
                    >
                    <input
                      type="text"
                      id="ContactForm-city"
                      name="contact[city]"
                      value="{% if form.city %}{{ form.city }}{% endif %}"
                      required
                    >
                  </div>
                </div>

                <div class="form-field-group">
                  <div class="form-field">
                    <label for="ContactForm-country">
                      {{- 'customer.vat_form.country' | t }}
                      <span aria-hidden="true">*</span></label
                    >
                    <select id="ContactForm-country" name="contact[country]" required>
                      <option value="">{{ 'customer.vat_form.select_country' | t }}</option>
                      {% for country in shop.enabled_countries %}
                        <option value="{{ country.iso_code }}">{{ country.name }}</option>
                      {% endfor %}
                    </select>
                  </div>
                  <div class="form-field">
                    <label for="ContactForm-vatId">
                      {{- 'customer.vat_form.vat_id' | t }}
                      <span aria-hidden="true">*</span></label
                    >
                    <input
                      type="text"
                      id="ContactForm-vatId"
                      name="contact[vat_id]"
                      value="{% if form.vat_id %}{{ form.vat_id }}{% endif %}"
                      required
                    >
                  </div>
                </div>

                <div class="form-submit-group">
                  <button type="button" class="button button--secondary" data-custom-close>
                    {{ settings.cart_popup_vat_id_cancel_label | default: 'Cancel' }}
                  </button>
                  <button type="submit" class="button button--primary" id="vatIdForm-submit">
                    {{ settings.cart_popup_vat_id_submit_label | default: 'Submit' }}
                  </button>
                </div>
              {%- endform -%}
            </div>

            <script>
              // Internationales Telefon-Input für das VAT-ID-Formular
              document.addEventListener('DOMContentLoaded', function () {
                if (typeof window.intlTelInput !== 'undefined' && document.querySelector('#ContactForm-vatId-phone')) {
                  const vatPhoneInput = document.querySelector('#ContactForm-vatId-phone');
                  const vatIti = window.intlTelInput(vatPhoneInput, {
                    initialCountry: 'de',
                    separateDialCode: true,
                    preferredCountries: ['de', 'at', 'ch'],
                    utilsScript: 'https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.19/js/utils.js',
                    allowDropdown: true,
                    autoPlaceholder: 'polite',
                    customContainer: 'phone-input-container',
                    formatOnDisplay: true,
                  });

                  // Store the full phone number including country code on form submission
                  document.getElementById('vatIdCartForm').addEventListener('submit', function () {
                    if (vatIti) {
                      const phoneNumber = vatIti.getNumber();
                      vatPhoneInput.value = phoneNumber;
                    }
                  });

                  // Fix für eventuelle Styling-Probleme
                  setTimeout(function () {
                    document.querySelectorAll('.iti').forEach(function (iti) {
                      iti.style.width = '100%';
                      iti.style.zIndex = '10';
                    });

                    const countryList = document.querySelector('.iti__country-list');
                    if (countryList) {
                      countryList.style.zIndex = '15';
                      countryList.style.position = 'absolute';
                    }
                  }, 100);
                }

                // Event-Listener für die Formular-Übermittlung hinzufügen
                if (document.getElementById('vatIdCartForm')) {
                  document.getElementById('vatIdCartForm').addEventListener('submit', function (e) {
                    // Verhindern, dass das Formular sofort abgesendet wird
                    e.preventDefault();

                    console.log('Formular wird abgesendet - leere den Warenkorb');

                    // Warenkorb leeren
                    fetch('/cart/clear.js', {
                      method: 'POST',
                      headers: {
                        'Content-Type': 'application/json',
                      },
                    })
                      .then((response) => response.json())
                      .then((data) => {
                        console.log('Warenkorb erfolgreich geleert:', data);

                        // Jetzt das Formular tatsächlich absenden
                        sessionStorage.setItem('vatIdFormSubmitted', 'true');
                        e.target.submit();
                      })
                      .catch((error) => {
                        console.error('Fehler beim Leeren des Warenkorbs:', error);
                        // Trotzdem das Formular absenden
                        e.target.submit();
                      });
                  });
                }
              });
            </script>
          </main>
        </div>
      </div>
    </div>

    <script>
      // Script zum Aktualisieren der Warenkorb-Informationen im VAT-ID-Formular
      document.addEventListener('DOMContentLoaded', function () {
        // Funktion, um das Warenkorb-Formular zu aktualisieren
        function updateVatIdCartForm() {
          // Prüfen, ob das Modal und die Formulare existieren
          const modal = document.getElementById('modal-cart-vat-id');
          if (!modal) return;

          console.log('Aktualisiere VAT-ID Formular mit aktuellen Warenkorb-Daten...');

          // Laden der aktuellen Warenkorb-Daten
          fetch('/cart.js')
            .then((response) => response.json())
            .then((cart) => {
              // Formatieren der Warenkorbdaten für das Formular
              let cartItemsValue = '';
              let cartItemsHtml = '';

              cart.items.forEach((item, index) => {
                const title = item.product_title;
                const variant = item.variant_title || 'Default Title';
                const quantity = item.quantity;
                const price = (item.final_price / 100).toLocaleString(window.Shopify?.locale || 'de-DE', {
                  style: 'currency',
                  currency: window.Shopify?.currency?.active || 'EUR',
                });
                const linePrice = (item.final_line_price / 100).toLocaleString(window.Shopify?.locale || 'de-DE', {
                  style: 'currency',
                  currency: window.Shopify?.currency?.active || 'EUR',
                });

                // Wert für das versteckte Eingabefeld
                cartItemsValue += `${title} (${variant}) - ${quantity}x - ${price}`;
                if (index < cart.items.length - 1) cartItemsValue += ' | ';

                // HTML für die Tabelle
                cartItemsHtml += `
                  <tr>
                    <td>
                      <div class="cart-item-name">${title}</div>
                      ${variant !== 'Default Title' ? `<div class="cart-item-variant">${variant}</div>` : ''}
                    </td>
                    <td>${quantity}</td>
                    <td>${linePrice}</td>
                  </tr>
                `;
              });

              // Gesamtpreis formatieren
              const totalPrice = (cart.total_price / 100).toLocaleString(window.Shopify?.locale || 'de-DE', {
                style: 'currency',
                currency: window.Shopify?.currency?.active || 'EUR',
              });

              // Aktualisieren der Formularelemente
              const cartItemsField = document.getElementById('vatIdForm-cart_items');
              const cartTotalField = document.getElementById('vatIdForm-cart_total');
              const cartItemsContainer = document.getElementById('vatIdForm-cart-items');
              const cartTotalContainer = document.getElementById('vatIdForm-cart-total');

              if (cartItemsField) cartItemsField.value = cartItemsValue;
              if (cartTotalField) cartTotalField.value = totalPrice;
              if (cartItemsContainer) cartItemsContainer.innerHTML = cartItemsHtml;
              if (cartTotalContainer) cartTotalContainer.innerHTML = `<strong>${totalPrice}</strong>`;

              console.log('VAT-ID Formular wurde mit den aktuellen Warenkorb-Daten aktualisiert.');
            })
            .catch((error) => {
              console.error('Fehler beim Aktualisieren des VAT-ID Formulars:', error);
            });
        }

        // Event-Listener für das Öffnen des VAT-ID-Modals
        if (typeof MicroModal !== 'undefined') {
          // Erweitern der bestehenden show-Methode, um bei Öffnung zu aktualisieren
          const originalShow = MicroModal.show;
          MicroModal.show = function (modalId, ...args) {
            if (modalId === 'modal-cart-vat-id') {
              updateVatIdCartForm();
            }
            return originalShow.call(this, modalId, ...args);
          };
        }

        // Event-Listener für Warenkorb-Änderungen
        document.addEventListener('cart:updated', function (event) {
          updateVatIdCartForm();
        });

        // Event-Listener für den VAT-ID-Button-Klick, um auch hier zu aktualisieren
        document.addEventListener('click', function (event) {
          const vatIdButton = event.target.closest('#CartDrawer-VatIdButton');
          if (vatIdButton) {
            updateVatIdCartForm();
          }
        });
      });
    </script>
  {% endif %}
</div>
