{% comment %}
  Dieses Snippet enthält alle Pop-Ups und lädt die Inhalte direkt aus den Theme-Einstellungen
{% endcomment %}

{%- style -%}
  {% if settings.popup_certificate_origin_use_arrow_divider %}
  #modal-certificate-origin .arrow-container .arrow-left,
  #modal-certificate-origin .arrow-container .arrow-right {
    width: {{ settings.popup_certificate_origin_arrow_width | default: 150 }}px;
    height: {{ settings.popup_certificate_origin_arrow_thickness | default: 1 }}px;
  }

  #modal-certificate-origin .arrow-container .arrow-left::before,
  #modal-certificate-origin .arrow-container .arrow-right::before {
    background-color: {{ settings.popup_certificate_origin_arrow_color | default: '#b9bfb1' }};
    height: {{ settings.popup_certificate_origin_arrow_thickness | default: 1 }}px;
  }

  #modal-certificate-origin .arrow-container .arrow-left::after {
    border-color: transparent {{ settings.popup_certificate_origin_arrow_color | default: '#b9bfb1' }} transparent transparent;
  }

  #modal-certificate-origin .arrow-container .arrow-right::after {
    border-color: transparent transparent transparent {{ settings.popup_certificate_origin_arrow_color | default: '#b9bfb1' }};
  }
  {% endif %}

  {% if settings.popup_clearance_certificate_use_arrow_divider %}
  #modal-clearance-certificate .arrow-container .arrow-left,
  #modal-clearance-certificate .arrow-container .arrow-right {
    width: {{ settings.popup_clearance_certificate_arrow_width | default: 150 }}px;
    height: {{ settings.popup_clearance_certificate_arrow_thickness | default: 1 }}px;
  }

  #modal-clearance-certificate .arrow-container .arrow-left::before,
  #modal-clearance-certificate .arrow-container .arrow-right::before {
    background-color: {{ settings.popup_clearance_certificate_arrow_color | default: '#b9bfb1' }};
    height: {{ settings.popup_clearance_certificate_arrow_thickness | default: 1 }}px;
  }

  #modal-clearance-certificate .arrow-container .arrow-left::after {
    border-color: transparent {{ settings.popup_clearance_certificate_arrow_color | default: '#b9bfb1' }} transparent transparent;
  }

  #modal-clearance-certificate .arrow-container .arrow-right::after {
    border-color: transparent transparent transparent {{ settings.popup_clearance_certificate_arrow_color | default: '#b9bfb1' }};
  }
  {% endif %}

  {% if settings.popup_vat_uid_tva_use_arrow_divider %}
  #modal-vat-uid-tva .arrow-container .arrow-left,
  #modal-vat-uid-tva .arrow-container .arrow-right {
    width: {{ settings.popup_vat_uid_tva_arrow_width | default: 150 }}px;
    height: {{ settings.popup_vat_uid_tva_arrow_thickness | default: 1 }}px;
  }

  #modal-vat-uid-tva .arrow-container .arrow-left::before,
  #modal-vat-uid-tva .arrow-container .arrow-right::before {
    background-color: {{ settings.popup_vat_uid_tva_arrow_color | default: '#b9bfb1' }};
    height: {{ settings.popup_vat_uid_tva_arrow_thickness | default: 1 }}px;
  }

  #modal-vat-uid-tva .arrow-container .arrow-left::after {
    border-color: transparent {{ settings.popup_vat_uid_tva_arrow_color | default: '#b9bfb1' }} transparent transparent;
  }

  #modal-vat-uid-tva .arrow-container .arrow-right::after {
    border-color: transparent transparent transparent {{ settings.popup_vat_uid_tva_arrow_color | default: '#b9bfb1' }};
  }
  {% endif %}
{%- endstyle -%}

<div class="popup-container">
  {% comment %} Certificate of Origin Pop-Up {% endcomment %}
  {% if settings.popup_certificate_origin_enable %}
    <div class="modal micromodal-slide" id="modal-certificate-origin" aria-hidden="true">
      <div class="modal__overlay" tabindex="-1" data-custom-close>
        <div class="modal__container" role="dialog" aria-modal="true" aria-labelledby="modal-certificate-origin-title">
          <button class="modal__close" aria-label="Close modal" data-custom-close>x</button>
          <header class="modal__header">
            <h2 class="modal__title" id="modal-certificate-origin-title">
              {{ settings.popup_certificate_origin_headline }}
            </h2>
            {% if settings.popup_certificate_origin_use_arrow_divider %}
              <div class="arrow-container">
                <div class="arrow-left"></div>
                <h3>{{ settings.popup_certificate_origin_abbr }}</h3>
                <div class="arrow-right"></div>
              </div>
            {% else %}
              <h3>{{ settings.popup_certificate_origin_abbr }}</h3>
            {% endif %}
          </header>
          <main class="modal__content" id="modal-certificate-origin-content">
            <div class="modal__text">
              {{ settings.popup_certificate_origin_text }}
            </div>

            {% if settings.popup_certificate_origin_more_info != blank %}
              <div class="modal__more-info">
                <div class="modal__more-info-content">
                  {{ settings.popup_certificate_origin_more_info }}
                </div>
              </div>
            {% endif %}
          </main>
        </div>
      </div>
    </div>
  {% endif %}

  {% comment %} Clearance Certificate Pop-Up {% endcomment %}
  {% if settings.popup_clearance_certificate_enable %}
    <div class="modal micromodal-slide" id="modal-clearance-certificate" aria-hidden="true">
      <div class="modal__overlay" tabindex="-1" data-custom-close>
        <div
          class="modal__container"
          role="dialog"
          aria-modal="true"
          aria-labelledby="modal-clearance-certificate-title"
        >
          <button class="modal__close" aria-label="Close modal" data-custom-close>x</button>
          <header class="modal__header">
            <h2 class="modal__title" id="modal-clearance-certificate-title">
              {{ settings.popup_clearance_certificate_headline }}
            </h2>
            {% if settings.popup_clearance_certificate_use_arrow_divider %}
              <div class="arrow-container">
                <div class="arrow-left"></div>
                <h3>{{ settings.popup_clearance_certificate_abbr }}</h3>
                <div class="arrow-right"></div>
              </div>
            {% else %}
              <h3>{{ settings.popup_clearance_certificate_abbr }}</h3>
            {% endif %}
          </header>
          <main class="modal__content" id="modal-clearance-certificate-content">
            <div class="modal__text">
              {{ settings.popup_clearance_certificate_text }}
            </div>

            {% if settings.popup_clearance_certificate_more_info != blank %}
              <div class="modal__more-info">
                <div class="modal__more-info-content">
                  {{ settings.popup_clearance_certificate_more_info }}
                </div>
              </div>
            {% endif %}
          </main>
        </div>
      </div>
    </div>
  {% endif %}

  {% comment %} VAT | UID | TVA Pop-Up {% endcomment %}
  {% if settings.popup_vat_uid_tva_enable %}
    <div class="modal micromodal-slide" id="modal-vat-uid-tva" aria-hidden="true">
      <div class="modal__overlay" tabindex="-1" data-custom-close>
        <div
          class="modal__container modal__container--wide"
          role="dialog"
          aria-modal="true"
          aria-labelledby="modal-vat-uid-tva-title"
        >
          <button class="modal__close" aria-label="Close modal" data-custom-close>x</button>
          <header class="modal__header">
            <h2 class="modal__title" id="modal-vat-uid-tva-title">
              {{ settings.popup_vat_uid_tva_headline }}
            </h2>
            {% if settings.popup_vat_uid_tva_use_arrow_divider %}
              <div class="arrow-container">
                <div class="arrow-left"></div>
                <h3>{{ settings.popup_vat_uid_tva_abbr }}</h3>
                <div class="arrow-right"></div>
              </div>
            {% else %}
              <h3>{{ settings.popup_vat_uid_tva_abbr }}</h3>
            {% endif %}
          </header>
          <main class="modal__content" id="modal-vat-uid-tva-content">
            <div class="modal__columns">
              <div class="modal__column">
                {{ settings.popup_vat_uid_tva_text_col1 }}
              </div>
              <div class="modal__column">
                {{ settings.popup_vat_uid_tva_text_col2 }}
              </div>
              <div class="modal__column">
                {{ settings.popup_vat_uid_tva_text_col3 }}
              </div>
            </div>
            {% if settings.popup_vat_uid_tva_more_info != blank %}
              <div class="modal__more-info">
                <div class="modal__more-info-content">
                  {{ settings.popup_vat_uid_tva_more_info }}
                </div>
              </div>
            {% endif %}
          </main>
        </div>
      </div>
    </div>
  {% endif %}

  {% comment %} VAT ID Cart Form Pop-Up {% endcomment %}
  {% if settings.cart_popup_vat_id_enable %}
    <div class="modal micromodal-slide" id="modal-cart-vat-id" aria-hidden="true">
      <div class="modal__overlay" tabindex="-1" data-custom-close>
        <div
          class="modal__container"
          role="dialog"
          aria-modal="true"
          aria-labelledby="modal-cart-vat-id-title"
        >
          <button class="modal__close" aria-label="Close modal" data-custom-close>x</button>
          <header class="modal__header">
            <h2 class="modal__title" id="modal-cart-vat-id-title">
              {{ settings.cart_popup_vat_id_headline }}
            </h2>
          </header>
          <main class="modal__content" id="modal-cart-vat-id-content">
            <div class="modal__text">
              {{ settings.cart_popup_vat_id_text }}
            </div>

            <div id="vatIdCartFormContainer">
              {%- form 'contact', id: 'vatIdCartForm', class: 'vat-id-form' -%}
                <div class="form-field vat-field-full-width">
                  <label for="ContactForm-vatId">
                    {{- 'customer.vat_form.vat_id' | t }}
                    <span aria-hidden="true">*</span></label
                  >
                  <div class="vat-id-input-wrapper">
                    <input
                      type="text"
                      id="ContactForm-vatId"
                      name="contact[vat_id]"
                      value="{% if form.vat_id %}{{ form.vat_id }}{% endif %}"
                      required
                    >
                    <div id="vatIdValidationStatus" class="vat-id-validation-status"></div>
                  </div>
                  <div id="vatIdValidationMessage" class="vat-id-validation-message"></div>
                </div>
                {% if form.posted_successfully? %}
                  <div class="form-success">
                    {{ settings.cart_popup_vat_id_success_message }}
                  </div>
                  <script>
                    // Sofortiges Leeren des Warenkorbs bei erfolgreicher VAT-ID Formularübermittlung
                    (function () {
                      // Prüfen, ob wir durch URL-Parameter erkennen können, dass das VAT-ID Formular erfolgreich gesendet wurde
                      const urlParams = new URLSearchParams(window.location.search);
                      const isFormSuccess = urlParams.get('form_submission') === 'success';
                      const isVatIdForm =
                        urlParams.get('form_type') === 'vat_id' ||
                        document.querySelector('#vatIdForm') !== null ||
                        window.location.pathname.includes('vat-id') ||
                        document.querySelector('form[action*="vat"]') !== null;

                      // Nur bei VAT-ID Formularen ausführen, nicht bei anderen Formularen wie Request-Only
                      if (isFormSuccess && isVatIdForm && !sessionStorage.getItem('vatIdFormProcessed')) {
                        console.log('VAT-ID Formular erfolgreich gesendet - leere Warenkorb');

                        // Markieren, dass wir diesen Prozess bereits durchgeführt haben
                        sessionStorage.setItem('vatIdFormProcessed', 'true');

                        // Warenkorb leeren
                        fetch('/cart/clear.js', {
                          method: 'POST',
                          headers: {
                            'Content-Type': 'application/json',
                          },
                        })
                          .then((response) => response.json())
                          .then((data) => {
                            console.log('Warenkorb erfolgreich geleert:', data);

                            // Schließen des Modals nach kurzer Verzögerung
                            setTimeout(function () {
                              if (typeof MicroModal !== 'undefined') {
                                MicroModal.close('modal-cart-vat-id');
                              }
                            }, 2000);
                          })
                          .catch((error) => {
                            console.error('Fehler beim Leeren des Warenkorbs:', error);
                          });
                      }
                    })();
                  </script>
                {% elsif form.errors %}
                  <div class="form-error">
                    <h2>
                      {{ 'templates.contact.form.error_heading' | t }}
                    </h2>
                    <ul>
                      {% for field in form.errors %}
                        <li>
                          <a href="#ContactForm-{{ field }}">
                            {{ form.errors.translated_fields[field] | capitalize }}
                            {{ form.errors.messages[field] }}
                          </a>
                        </li>
                      {% endfor %}
                    </ul>
                  </div>
                {% endif %}

                <input type="hidden" name="contact[form_type]" value="VAT ID Form">

                {% comment %} Produktdaten aus dem Warenkorb hinzufügen {% endcomment %}
                <input
                  type="hidden"
                  id="vatIdForm-cart_items"
                  name="contact[cart_items]"
                  value=""
                >
                <input
                  type="hidden"
                  id="vatIdForm-cart_total"
                  name="contact[cart_total]"
                  value=""
                >

                <div class="cart-items-summary" id="vatIdForm-cart-summary">
                  <h3>{{ 'sections.cart.caption' | t }}</h3>
                  <table class="cart-items-table">
                    <thead>
                      <tr>
                        <th>{{ 'sections.cart.headings.product' | t }}</th>
                        <th>{{ 'sections.cart.headings.quantity' | t }}</th>
                        <th>{{ 'sections.cart.headings.price' | t }}</th>
                      </tr>
                    </thead>
                    <tbody id="vatIdForm-cart-items">
                      {% for item in cart.items %}
                        <tr>
                          <td>
                            <div class="cart-item-name">{{ item.product.title }}</div>
                            {% if item.variant.title != 'Default Title' %}
                              <div class="cart-item-variant">{{ item.variant.title }}</div>
                            {% endif %}
                            <div class="cart-item-sku">SKU: {{ item.sku || 'N/A' }}</div>
                          </td>
                          <td>{{ item.quantity }}</td>
                          <td>{{ item.final_line_price | money }}</td>
                        </tr>
                      {% endfor %}
                    </tbody>
                    <tfoot>
                      <tr>
                        <td colspan="2">{{ 'sections.cart.estimated_total' | t }}:</td>
                        <td id="vatIdForm-cart-total">
                          <strong>{{ cart.total_price | money }}</strong>
                        </td>
                      </tr>
                    </tfoot>
                  </table>
                </div>

                <div class="form-field-group">
                  <div class="form-field">
                    <label for="ContactForm-firstName">
                      {{- 'customer.vat_form.first_name' | t }}
                      <span aria-hidden="true">*</span></label
                    >
                    <input
                      type="text"
                      id="ContactForm-firstName"
                      name="contact[first_name]"
                      value="{% if form.first_name %}{{ form.first_name }}{% endif %}"
                      autocomplete="given-name"
                      required
                    >
                  </div>
                  <div class="form-field">
                    <label for="ContactForm-lastName">
                      {{- 'customer.vat_form.last_name' | t }}
                      <span aria-hidden="true">*</span></label
                    >
                    <input
                      type="text"
                      id="ContactForm-lastName"
                      name="contact[last_name]"
                      value="{% if form.last_name %}{{ form.last_name }}{% endif %}"
                      autocomplete="family-name"
                      required
                    >
                  </div>
                </div>

                <div class="form-field-group">
                  <div class="form-field">
                    <label for="ContactForm-email">
                      {{- 'customer.vat_form.email' | t }}
                      <span aria-hidden="true">*</span></label
                    >
                    <input
                      type="email"
                      id="ContactForm-email"
                      name="contact[email]"
                      value="{% if form.email %}{{ form.email }}{% endif %}"
                      autocomplete="email"
                      spellcheck="false"
                      autocapitalize="off"
                      required
                    >
                  </div>
                  <div class="form-field">
                    <label for="ContactForm-phone">
                      {{- 'customer.vat_form.phone' | t }}
                      <span aria-hidden="true">*</span></label
                    >
                    <input
                      type="tel"
                      id="ContactForm-phone"
                      name="contact[phone]"
                      value="{% if form.phone %}{{ form.phone }}{% endif %}"
                      autocomplete="tel"
                      required
                    >
                  </div>
                </div>

                <div class="form-field">
                  <label for="ContactForm-company">
                    {{- 'customer.vat_form.company' | t }}
                    <span aria-hidden="true">*</span></label
                  >
                  <input
                    type="text"
                    id="ContactForm-company"
                    name="contact[company]"
                    value="{% if form.company %}{{ form.company }}{% endif %}"
                    required
                  >
                </div>

                <div class="form-field">
                  <label for="ContactForm-address">
                    {{- 'customer.vat_form.address' | t }}
                    <span aria-hidden="true">*</span></label
                  >
                  <input
                    type="text"
                    id="ContactForm-address"
                    name="contact[address]"
                    value="{% if form.address %}{{ form.address }}{% endif %}"
                    required
                  >
                </div>

                <div class="form-field-group">
                  <div class="form-field">
                    <label for="ContactForm-postalCode">
                      {{- 'customer.vat_form.postal_code' | t }}
                      <span aria-hidden="true">*</span></label
                    >
                    <input
                      type="text"
                      id="ContactForm-postalCode"
                      name="contact[postal_code]"
                      value="{% if form.postal_code %}{{ form.postal_code }}{% endif %}"
                      required
                    >
                  </div>
                  <div class="form-field">
                    <label for="ContactForm-city">
                      {{- 'customer.vat_form.city' | t }}
                      <span aria-hidden="true">*</span></label
                    >
                    <input
                      type="text"
                      id="ContactForm-city"
                      name="contact[city]"
                      value="{% if form.city %}{{ form.city }}{% endif %}"
                      required
                    >
                  </div>
                </div>

                <div class="form-field-group">
                  <div class="form-field">
                    <label for="ContactForm-country">
                      {{- 'customer.vat_form.country' | t }}
                      <span aria-hidden="true">*</span></label
                    >
                    <select id="ContactForm-country" name="contact[country]" required>
                      <option value="">{{ 'customer.vat_form.select_country' | t }}</option>
                      {% for country in shop.enabled_countries %}
                        <option value="{{ country.iso_code }}">{{ country.name }}</option>
                      {% endfor %}
                    </select>
                  </div>
                </div>

                <div class="form-submit-group">
                  <button type="button" class="button button--secondary btn-cancel" data-custom-close>
                    {{ settings.cart_popup_vat_id_cancel_label | default: 'Cancel' }}
                  </button>
                  <button type="submit" class="button button--primary" id="vatIdForm-submit">
                    {{ settings.cart_popup_vat_id_submit_label | default: 'Submit' }}
                  </button>
                </div>
              {%- endform -%}
            </div>

            <script>
              // Internationales Telefon-Input für das VAT-ID-Formular
              document.addEventListener('DOMContentLoaded', function () {
                // VAT ID Validierung initialisieren
                initVatIdValidation();

                if (typeof window.intlTelInput !== 'undefined' && document.querySelector('#ContactForm-vatId-phone')) {
                  const vatPhoneInput = document.querySelector('#ContactForm-vatId-phone');
                  const vatIti = window.intlTelInput(vatPhoneInput, {
                    initialCountry: 'de',
                    separateDialCode: true,
                    preferredCountries: ['de', 'at', 'ch'],
                    utilsScript: 'https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.19/js/utils.js',
                    allowDropdown: true,
                    autoPlaceholder: 'polite',
                    customContainer: 'phone-input-container',
                    formatOnDisplay: true,
                  });

                  // Store the full phone number including country code on form submission
                  document.getElementById('vatIdCartForm').addEventListener('submit', function () {
                    if (vatIti) {
                      const phoneNumber = vatIti.getNumber();
                      vatPhoneInput.value = phoneNumber;
                    }
                  });

                  // Fix für eventuelle Styling-Probleme
                  setTimeout(function () {
                    document.querySelectorAll('.iti').forEach(function (iti) {
                      iti.style.width = '100%';
                      iti.style.zIndex = '10';
                    });

                    const countryList = document.querySelector('.iti__country-list');
                    if (countryList) {
                      countryList.style.zIndex = '15';
                      countryList.style.position = 'absolute';
                    }
                  }, 100);
                }

                // Event-Listener für die Formular-Übermittlung hinzufügen
                if (document.getElementById('vatIdCartForm')) {
                  document.getElementById('vatIdCartForm').addEventListener('submit', function (e) {
                    // Verhindern, dass das Formular sofort abgesendet wird
                    e.preventDefault();

                    console.log('Formular wird abgesendet - leere den Warenkorb');

                    // Warenkorb leeren
                    fetch('/cart/clear.js', {
                      method: 'POST',
                      headers: {
                        'Content-Type': 'application/json',
                      },
                    })
                      .then((response) => response.json())
                      .then((data) => {
                        console.log('Warenkorb erfolgreich geleert:', data);

                        // Jetzt das Formular tatsächlich absenden
                        sessionStorage.setItem('vatIdFormSubmitted', 'true');
                        e.target.submit();
                      })
                      .catch((error) => {
                        console.error('Fehler beim Leeren des Warenkorbs:', error);
                        // Trotzdem das Formular absenden
                        e.target.submit();
                      });
                  });
                }
              });

              // Funktion zur Initialisierung der VAT-ID-Validierung
              function initVatIdValidation() {
                const vatIdInput = document.getElementById('ContactForm-vatId');
                const validationStatus = document.getElementById('vatIdValidationStatus');
                const companyInfoElement = document.getElementById('vatIdValidationMessage');
                const submitButton = document.getElementById('vatIdForm-submit');

                let isValidating = false;
                let lastValidatedValue = '';

                // VAT Validation APIs - Primary: EU VIES (kostenlos), Fallback: vatcheckapi.com
                const VAT_APIS = {
                  primary: {
                    name: 'EU VIES',
                    url: 'https://ec.europa.eu/taxation_customs/vies/rest-api/check-vat-number',
                    requiresKey: false,
                  },
                  fallback: {
                    name: 'VatCheckAPI',
                    url: 'https://api.vatcheckapi.com/v2/check',
                    requiresKey: true,
                    key: 'vat_live_iF5iSdIE2w0aPPYbbJbKClZuiJgxfNGHujzU2ERP',
                  },
                };

                // Debounce-Funktion zur Begrenzung der Validierungsaufrufe
                function debounce(func, wait) {
                  let timeout;
                  return function executedFunction(...args) {
                    const later = () => {
                      clearTimeout(timeout);
                      func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                  };
                }

                // Funktion zum Aktualisieren des Validierungsstatus
                function updateValidationStatus(status, message, companyInfo = null) {
                  validationStatus.className = 'vat-id-validation-status';
                  validationStatus.classList.add(`validation-${status}`);
                  validationStatus.textContent = message;

                  // Aktiviere oder deaktiviere den Submit-Button
                  if (status === 'success') {
                    submitButton.disabled = false;
                    submitButton.classList.remove('disabled');

                    // Firmeninformationen anzeigen, wenn verfügbar
                    if (companyInfo) {
                      companyInfoElement.innerHTML = `
                        <div class="company-info">
                          <p><strong>${companyInfo.name || ''}</strong></p>
                          <p>${companyInfo.address || ''}</p>
                        </div>
                      `;
                      companyInfoElement.style.display = 'block';
                    }
                  } else {
                    submitButton.disabled = status !== 'checking';
                    submitButton.classList.toggle('disabled', status !== 'checking');
                    companyInfoElement.style.display = 'none';
                    companyInfoElement.innerHTML = '';
                  }
                }

                // Funktion zur Vorvalidierung (Formatprüfung)
                function preValidateVatId(vatId) {
                  if (!vatId || vatId.trim().length < 3) {
                    return {
                      valid: false,
                      message:
                        "{{ 'customer.vat_form.enter_vat_id' | t | default: 'Bitte geben Sie eine Umsatzsteuer-ID ein' }}",
                    };
                  }

                  // VAT-ID Format: 2 Buchstaben Ländercode + 2-12 alphanumerische Zeichen
                  const vatIdRegex = /^([A-Z]{2})([0-9A-Z]{2,12})$/;
                  const match = vatId.trim().toUpperCase().match(vatIdRegex);

                  if (!match) {
                    return {
                      valid: false,
                      message:
                        "{{ 'customer.vat_form.invalid_format' | t | default: 'Ungültiges Format. Beispiel: DE123456789' }}",
                    };
                  }

                  const countryCode = match[1];
                  const vatNumber = match[2];

                  // Liste der unterstützten EU-Länder
                  const supportedCountries = [
                    'AT',
                    'BE',
                    'BG',
                    'CY',
                    'CZ',
                    'DE',
                    'DK',
                    'EE',
                    'ES',
                    'FI',
                    'FR',
                    'GR',
                    'HR',
                    'HU',
                    'IE',
                    'IT',
                    'LT',
                    'LU',
                    'LV',
                    'MT',
                    'NL',
                    'PL',
                    'PT',
                    'RO',
                    'SE',
                    'SI',
                    'SK',
                    'XI', // XI ist Nordirland
                  ];

                  if (!supportedCountries.includes(countryCode)) {
                    return {
                      valid: false,
                      message:
                        "{{ 'customer.vat_form.country_not_supported' | t | default: 'Ländercode nicht unterstützt' }}",
                    };
                  }

                  return {
                    valid: true,
                    countryCode,
                    vatNumber,
                    fullVatId: vatId.trim().toUpperCase(),
                  };
                }

                // Funktion zur Validierung der VAT-ID über die API mit Fallback-System
                async function validateVatId(vatId) {
                  if (isValidating || vatId === lastValidatedValue) return;

                  const preValidation = preValidateVatId(vatId);
                  if (!preValidation.valid) {
                    updateValidationStatus('error', preValidation.message);
                    return;
                  }

                  isValidating = true;
                  lastValidatedValue = vatId;

                  updateValidationStatus(
                    'checking',
                    "{{ 'customer.vat_form.validating' | t | default: 'Überprüfung läuft...' }}"
                  );

                  // Versuche zuerst die primäre API (EU VIES)
                  let validationResult = await tryVatValidation('primary', preValidation);

                  // Falls primäre API fehlschlägt, versuche Fallback
                  if (!validationResult.success) {
                    console.log('Primäre VAT API fehlgeschlagen, versuche Fallback...');
                    validationResult = await tryVatValidation('fallback', preValidation);
                  }

                  // Verarbeitung des Ergebnisses
                  if (validationResult.success) {
                    if (validationResult.data.valid) {
                      updateValidationStatus(
                        'success',
                        "{{ 'customer.vat_form.valid' | t | default: 'Gültige Umsatzsteuer-ID' }}",
                        validationResult.data.companyInfo
                      );
                    } else {
                      updateValidationStatus(
                        'error',
                        "{{ 'customer.vat_form.invalid' | t | default: 'Ungültige Umsatzsteuer-ID oder nicht registriert' }}"
                      );
                    }
                  } else {
                    console.error('Alle VAT-Validierungs-APIs fehlgeschlagen');
                    updateValidationStatus(
                      'error',
                      "{{ 'customer.vat_form.validation_error' | t | default: 'Fehler bei der Validierung. Bitte versuchen Sie es später erneut.' }}"
                    );
                  }

                  isValidating = false;
                }

                // Hilfsfunktion für VAT-Validierung mit spezifischer API
                async function tryVatValidation(apiType, preValidation) {
                  const api = VAT_APIS[apiType];

                  try {
                    let apiUrl, response, data;

                    if (apiType === 'primary') {
                      // EU VIES API
                      apiUrl = `${api.url}?countryCode=${preValidation.countryCode}&vatNumber=${preValidation.vatNumber}`;
                      console.log(`VAT-Validierung ${api.name} API-Anfrage an:`, apiUrl);

                      response = await fetch(apiUrl);
                      data = await response.json();

                      console.log(`VAT-Validierung ${api.name} Antwort:`, data);

                      // EU VIES Antwortformat verarbeiten
                      if (response.ok && data.valid !== undefined) {
                        return {
                          success: true,
                          data: {
                            valid: data.valid,
                            companyInfo: data.valid
                              ? {
                                  name: data.name || '',
                                  address: data.address || '',
                                }
                              : null,
                          },
                        };
                      }
                    } else if (apiType === 'fallback') {
                      // VatCheckAPI (ursprüngliche API)
                      apiUrl = `${api.url}?apikey=${api.key}&vat_number=${preValidation.fullVatId}`;
                      console.log(`VAT-Validierung ${api.name} API-Anfrage an:`, apiUrl);

                      response = await fetch(apiUrl);
                      data = await response.json();

                      console.log(`VAT-Validierung ${api.name} Antwort:`, data);

                      // VatCheckAPI Antwortformat verarbeiten
                      if (data.format_valid !== undefined) {
                        const isValid =
                          data.format_valid && data.registration_info && data.registration_info.is_registered;
                        return {
                          success: true,
                          data: {
                            valid: isValid,
                            companyInfo: isValid ? data.registration_info : null,
                          },
                        };
                      }
                    }

                    return { success: false, error: 'Unbekanntes Antwortformat' };
                  } catch (error) {
                    console.error(`Fehler bei ${api.name} VAT-Validierung:`, error);
                    return { success: false, error: error.message };
                  }
                }

                // Debounced Validierungsfunktion (Verzögerung, um API-Aufrufe zu begrenzen)
                const debouncedValidate = debounce((value) => {
                  validateVatId(value);
                }, 500);

                // Event-Listener für Eingabe
                vatIdInput.addEventListener('input', (e) => {
                  const value = e.target.value.trim();
                  if (value.length >= 4) {
                    debouncedValidate(value);
                  } else {
                    updateValidationStatus(
                      'warning',
                      "{{ 'customer.vat_form.enter_vat_id' | t | default: 'Bitte geben Sie eine Umsatzsteuer-ID ein' }}"
                    );
                    submitButton.disabled = true;
                    submitButton.classList.add('disabled');
                  }
                });

                // Event-Listener für Fokus-Verlust
                vatIdInput.addEventListener('blur', (e) => {
                  const value = e.target.value.trim();
                  if (value.length >= 4) {
                    validateVatId(value);
                  }
                });

                // Initial-Status
                updateValidationStatus(
                  'warning',
                  "{{ 'customer.vat_form.enter_vat_id' | t | default: 'Bitte geben Sie eine Umsatzsteuer-ID ein' }}"
                );
                submitButton.disabled = true;
                submitButton.classList.add('disabled');
              }
            </script>

            <style>
              /* Styles für die VAT-ID-Validierung */
              .vat-id-input-wrapper {
                position: relative;
                display: flex;
                align-items: center;
              }

              .vat-id-validation-status {
                margin-left: 10px;
                font-size: 0.9em;
                padding: 2px 8px;
                border-radius: 4px;
              }

              .validation-success {
                color: #28a745;
                background-color: #f0fff4;
              }

              .validation-error {
                color: #dc3545;
                background-color: #fff0f0;
              }

              .validation-warning {
                color: #fd7e14;
                background-color: #fff9f0;
              }

              .validation-checking {
                color: #17a2b8;
                background-color: #f0f9ff;
                position: relative;
                padding-right: 25px;
              }

              .validation-checking:after {
                content: '';
                position: absolute;
                right: 8px;
                top: 50%;
                transform: translateY(-50%);
                width: 12px;
                height: 12px;
                border: 2px solid currentColor;
                border-radius: 50%;
                border-right-color: transparent;
                animation: rotate 1s linear infinite;
              }

              @keyframes rotate {
                from {
                  transform: translateY(-50%) rotate(0deg);
                }
                to {
                  transform: translateY(-50%) rotate(360deg);
                }
              }

              .company-info {
                margin-top: 10px;
                padding: 8px;
                background-color: #f8f9fa;
                border-radius: 4px;
                font-size: 0.9em;
              }

              .button.disabled {
                opacity: 0.65;
                cursor: not-allowed;
              }

              .vat-id-validation-message {
                margin-top: 5px;
                width: 100%;
              }
            </style>
          </main>
        </div>
      </div>
    </div>

    <script>
      // Script zum Aktualisieren der Warenkorb-Informationen im VAT-ID-Formular
      document.addEventListener('DOMContentLoaded', function () {
        // Funktion, um das Warenkorb-Formular zu aktualisieren
        function updateVatIdCartForm() {
          // Prüfen, ob das Modal und die Formulare existieren
          const modal = document.getElementById('modal-cart-vat-id');
          if (!modal) return;

          console.log('Aktualisiere VAT-ID Formular mit aktuellen Warenkorb-Daten...');

          // Laden der aktuellen Warenkorb-Daten
          fetch('/cart.js')
            .then((response) => response.json())
            .then((cart) => {
              // Formatieren der Warenkorbdaten für das Formular
              let cartItemsValue = '';
              let cartItemsHtml = '';

              cart.items.forEach((item, index) => {
                const title = item.product_title;
                const variant = item.variant_title || 'Default Title';
                const sku = item.sku || 'N/A';
                const quantity = item.quantity;
                const price = (item.final_price / 100).toLocaleString(window.Shopify?.locale || 'de-DE', {
                  style: 'currency',
                  currency: window.Shopify?.currency?.active || 'EUR',
                });
                const linePrice = (item.final_line_price / 100).toLocaleString(window.Shopify?.locale || 'de-DE', {
                  style: 'currency',
                  currency: window.Shopify?.currency?.active || 'EUR',
                });

                // Wert für das versteckte Eingabefeld
                cartItemsValue += `${title} (${variant}) - SKU: ${sku} - ${quantity}x - ${price}`;
                if (index < cart.items.length - 1) cartItemsValue += ' | ';

                // HTML für die Tabelle
                cartItemsHtml += `
                  <tr>
                    <td>
                      <div class="cart-item-name">${title}</div>
                      ${variant !== 'Default Title' ? `<div class="cart-item-variant">${variant}</div>` : ''}
                      <div class="cart-item-sku">SKU: ${sku}</div>
                    </td>
                    <td>${quantity}</td>
                    <td>${linePrice}</td>
                  </tr>
                `;
              });

              // Gesamtpreis formatieren
              const totalPrice = (cart.total_price / 100).toLocaleString(window.Shopify?.locale || 'de-DE', {
                style: 'currency',
                currency: window.Shopify?.currency?.active || 'EUR',
              });

              // Aktualisieren der Formularelemente
              const cartItemsField = document.getElementById('vatIdForm-cart_items');
              const cartTotalField = document.getElementById('vatIdForm-cart_total');
              const cartItemsContainer = document.getElementById('vatIdForm-cart-items');
              const cartTotalContainer = document.getElementById('vatIdForm-cart-total');

              if (cartItemsField) cartItemsField.value = cartItemsValue;
              if (cartTotalField) cartTotalField.value = totalPrice;
              if (cartItemsContainer) cartItemsContainer.innerHTML = cartItemsHtml;
              if (cartTotalContainer) cartTotalContainer.innerHTML = `<strong>${totalPrice}</strong>`;

              console.log('VAT-ID Formular wurde mit den aktuellen Warenkorb-Daten aktualisiert.');
            })
            .catch((error) => {
              console.error('Fehler beim Aktualisieren des VAT-ID Formulars:', error);
            });
        }

        // Event-Listener für das Öffnen des VAT-ID-Modals
        if (typeof MicroModal !== 'undefined') {
          // Erweitern der bestehenden show-Methode, um bei Öffnung zu aktualisieren
          const originalShow = MicroModal.show;
          MicroModal.show = function (modalId, ...args) {
            if (modalId === 'modal-cart-vat-id') {
              updateVatIdCartForm();
            }
            return originalShow.call(this, modalId, ...args);
          };
        }

        // Event-Listener für Warenkorb-Änderungen
        document.addEventListener('cart:updated', function (event) {
          updateVatIdCartForm();
        });

        // Event-Listener für den VAT-ID-Button-Klick, um auch hier zu aktualisieren
        document.addEventListener('click', function (event) {
          const vatIdButton = event.target.closest('#CartDrawer-VatIdButton');
          if (vatIdButton) {
            updateVatIdCartForm();
          }
        });
      });
    </script>
  {% endif %}

  {% comment %} Request Only Product Pop-Up {% endcomment %}
  {% if settings.request_only_popup_enable %}
    <div class="modal micromodal-slide" id="modal-request-only" aria-hidden="true">
      <div class="modal__overlay" tabindex="-1" data-custom-close>
        <div
          class="modal__container"
          role="dialog"
          aria-modal="true"
          aria-labelledby="modal-request-only-title"
        >
          <button class="modal__close" aria-label="Close modal" data-custom-close>x</button>
          <header class="modal__header">
            <h2 class="modal__title" id="modal-request-only-title">
              {% liquid
                case request.locale.iso_code
                  when 'de'
                    echo settings.request_only_popup_headline_de
                  when 'en'
                    echo settings.request_only_popup_headline_en
                  when 'it'
                    echo settings.request_only_popup_headline_it
                  when 'es'
                    echo settings.request_only_popup_headline_es
                  when 'fr'
                    echo settings.request_only_popup_headline_fr
                  else
                    echo settings.request_only_popup_headline_de
                endcase
              %}
            </h2>
          </header>
          <main class="modal__content" id="modal-request-only-content">
            <div class="modal__text">
              {% liquid
                case request.locale.iso_code
                  when 'de'
                    echo settings.request_only_popup_text_de
                  when 'en'
                    echo settings.request_only_popup_text_en
                  when 'it'
                    echo settings.request_only_popup_text_it
                  when 'es'
                    echo settings.request_only_popup_text_es
                  when 'fr'
                    echo settings.request_only_popup_text_fr
                  else
                    echo settings.request_only_popup_text_de
                endcase
              %}
            </div>

            <div id="requestOnlyFormContainer">
              <!-- Success Message Container (initially hidden) -->
              <div id="requestOnlySuccessContainer" class="form-success" style="display: none;">
                <div id="requestOnlySuccessMessage">
                  <!-- Success message will be inserted here via JavaScript -->
                </div>
                <div style="text-align: center; margin-top: 20px;">
                  <button type="button" class="button button--primary" data-custom-close>
                    {% liquid
                      case request.locale.iso_code
                        when 'de'
                          echo 'Schließen'
                        when 'en'
                          echo 'Close'
                        when 'it'
                          echo 'Chiudi'
                        when 'es'
                          echo 'Cerrar'
                        when 'fr'
                          echo 'Fermer'
                        else
                          echo 'Schließen'
                      endcase
                    %}
                  </button>
                </div>
              </div>

              {%- form 'contact', id: 'requestOnlyForm', class: 'request-only-form' -%}
                {% if form.posted_successfully? %}
                  <div class="form-success">
                    {% liquid
                      case request.locale.iso_code
                        when 'de'
                          echo settings.request_only_success_message_de
                        when 'en'
                          echo settings.request_only_success_message_en
                        when 'it'
                          echo settings.request_only_success_message_it
                        when 'es'
                          echo settings.request_only_success_message_es
                        when 'fr'
                          echo settings.request_only_success_message_fr
                        else
                          echo settings.request_only_success_message_de
                      endcase
                    %}
                  </div>
                  <script>
                    setTimeout(function () {
                      if (typeof MicroModal !== 'undefined') {
                        MicroModal.close('modal-request-only');
                      }
                    }, 3000);
                  </script>
                {% elsif form.errors %}
                  <div class="form-error">
                    <h2>
                      {% liquid
                        case request.locale.iso_code
                          when 'de'
                            echo 'Bitte korrigieren Sie folgende Fehler:'
                          when 'en'
                            echo 'Please correct the following errors:'
                          when 'it'
                            echo 'Si prega di correggere i seguenti errori:'
                          when 'es'
                            echo 'Por favor corrija los siguientes errores:'
                          when 'fr'
                            echo 'Veuillez corriger les erreurs suivantes:'
                          else
                            echo 'Bitte korrigieren Sie folgende Fehler:'
                        endcase
                      %}
                    </h2>
                    <ul>
                      {% for field in form.errors %}
                        <li>
                          <a href="#RequestOnlyForm-{{ field }}">
                            {{ form.errors.translated_fields[field] | capitalize }}
                            {{ form.errors.messages[field] }}
                          </a>
                        </li>
                      {% endfor %}
                    </ul>
                  </div>
                {% endif %}

                <input type="hidden" name="contact[form_type]" value="Product Request Form">

                {% comment %} Produktdaten hinzufügen {% endcomment %}
                <input type="hidden" id="requestOnlyForm-product_id" name="contact[product_id]" value="">
                <input type="hidden" id="requestOnlyForm-product_title" name="contact[product_title]" value="">
                <input type="hidden" id="requestOnlyForm-product_url" name="contact[product_url]" value="">
                <input type="hidden" id="requestOnlyForm-product_sku" name="contact[product_sku]" value="">
                <input type="hidden" id="requestOnlyForm-product_price" name="contact[product_price]" value="">

                <div class="product-summary" id="requestOnlyForm-product-summary">
                  <h3>
                    {% liquid
                      case request.locale.iso_code
                        when 'de'
                          echo 'Angefragtes Produkt'
                        when 'en'
                          echo 'Requested Product'
                        when 'it'
                          echo 'Prodotto Richiesto'
                        when 'es'
                          echo 'Producto Solicitado'
                        when 'fr'
                          echo 'Produit Demandé'
                        else
                          echo 'Angefragtes Produkt'
                      endcase
                    %}
                  </h3>
                  <table class="product-table">
                    <thead>
                      <tr>
                        <th>{{ 'sections.cart.headings.product' | t }}</th>
                        <th>{{ 'products.product.sku' | t }}</th>
                        <th>{{ 'sections.cart.headings.price' | t }}</th>
                      </tr>
                    </thead>
                    <tbody id="requestOnlyForm-product-details">
                      <tr>
                        <td>
                          <div class="product-item-name" id="requestOnlyForm-display-title">-</div>
                        </td>
                        <td id="requestOnlyForm-display-sku">-</td>
                        <td id="requestOnlyForm-display-price">-</td>
                      </tr>
                    </tbody>
                  </table>
                </div>

                <div class="form-field-group">
                  <div class="form-field">
                    <label for="RequestOnlyForm-firstName">
                      {{- 'customer.vat_form.first_name' | t }}
                      <span aria-hidden="true">*</span></label
                    >
                    <input
                      type="text"
                      id="RequestOnlyForm-firstName"
                      name="contact[first_name]"
                      value="{% if form.first_name %}{{ form.first_name }}{% endif %}"
                      autocomplete="given-name"
                      required
                    >
                  </div>
                  <div class="form-field">
                    <label for="RequestOnlyForm-lastName">
                      {{- 'customer.vat_form.last_name' | t }}
                      <span aria-hidden="true">*</span></label
                    >
                    <input
                      type="text"
                      id="RequestOnlyForm-lastName"
                      name="contact[last_name]"
                      value="{% if form.last_name %}{{ form.last_name }}{% endif %}"
                      autocomplete="family-name"
                      required
                    >
                  </div>
                </div>

                <div class="form-field-group">
                  <div class="form-field">
                    <label for="RequestOnlyForm-email">
                      {{- 'customer.vat_form.email' | t }}
                      <span aria-hidden="true">*</span></label
                    >
                    <input
                      type="email"
                      id="RequestOnlyForm-email"
                      name="contact[email]"
                      value="{% if form.email %}{{ form.email }}{% endif %}"
                      autocomplete="email"
                      spellcheck="false"
                      autocapitalize="off"
                      required
                    >
                  </div>
                  <div class="form-field">
                    <label for="RequestOnlyForm-phone">
                      {{- 'customer.vat_form.phone' | t }}
                      <span aria-hidden="true">*</span></label
                    >
                    <input
                      type="tel"
                      id="RequestOnlyForm-phone"
                      name="contact[phone]"
                      value="{% if form.phone %}{{ form.phone }}{% endif %}"
                      autocomplete="tel"
                      required
                    >
                  </div>
                </div>

                <div class="form-field">
                  <label for="RequestOnlyForm-message">
                    {% liquid
                      case request.locale.iso_code
                        when 'de'
                          echo 'Nachricht'
                        when 'en'
                          echo 'Message'
                        when 'it'
                          echo 'Messaggio'
                        when 'es'
                          echo 'Mensaje'
                        when 'fr'
                          echo 'Message'
                        else
                          echo 'Nachricht'
                      endcase
                    %}
                  </label>
                  <textarea
                    id="RequestOnlyForm-message"
                    name="contact[body]"
                    rows="4"
                    placeholder="
                      {% liquid
                        case request.locale.iso_code
                          when 'de'
                            echo 'Ihre Nachricht bezüglich des Produkts...'
                          when 'en'
                            echo 'Your message regarding the product...'
                          when 'it'
                            echo 'Il vostro messaggio riguardo al prodotto...'
                          when 'es'
                            echo 'Su mensaje sobre el producto...'
                          when 'fr'
                            echo 'Votre message concernant le produit...'
                          else
                            echo 'Ihre Nachricht bezüglich des Produkts...'
                        endcase
                      %}
                    "
                  ></textarea>
                </div>

                <div class="form-submit-group">
                  <button type="button" class="button button--secondary btn-cancel" data-custom-close>
                    {% liquid
                      case request.locale.iso_code
                        when 'de'
                          echo settings.request_only_cancel_label_de
                        when 'en'
                          echo settings.request_only_cancel_label_en
                        when 'it'
                          echo settings.request_only_cancel_label_it
                        when 'es'
                          echo settings.request_only_cancel_label_es
                        when 'fr'
                          echo settings.request_only_cancel_label_fr
                        else
                          echo settings.request_only_cancel_label_de
                      endcase
                    %}
                  </button>
                  <button type="submit" class="button button--primary" id="requestOnlyForm-submit">
                    {% liquid
                      case request.locale.iso_code
                        when 'de'
                          echo settings.request_only_submit_label_de
                        when 'en'
                          echo settings.request_only_submit_label_en
                        when 'it'
                          echo settings.request_only_submit_label_it
                        when 'es'
                          echo settings.request_only_submit_label_es
                        when 'fr'
                          echo settings.request_only_submit_label_fr
                        else
                          echo settings.request_only_submit_label_de
                      endcase
                    %}
                  </button>
                </div>
              {%- endform -%}
            </div>
          </main>
        </div>
      </div>
    </div>

    {% comment %} Request Only Success Pop-Up {% endcomment %}
    <div class="modal micromodal-slide" id="modal-request-success" aria-hidden="true">
      <div class="modal__overlay" tabindex="-1" data-custom-close>
        <div
          class="modal__container"
          role="dialog"
          aria-modal="true"
          aria-labelledby="modal-request-success-title"
        >
          <button class="modal__close" aria-label="Close modal" data-custom-close>x</button>
          <header class="modal__header">
            <h2 class="modal__title" id="modal-request-success-title">
              {% liquid
                case request.locale.iso_code
                  when 'de'
                    echo 'Anfrage erfolgreich gesendet'
                  when 'en'
                    echo 'Inquiry sent successfully'
                  when 'it'
                    echo 'Richiesta inviata con successo'
                  when 'es'
                    echo 'Consulta enviada exitosamente'
                  when 'fr'
                    echo 'Demande envoyée avec succès'
                  else
                    echo 'Anfrage erfolgreich gesendet'
                endcase
              %}
            </h2>
          </header>
          <main class="modal__content">
            <div class="modal__text">
              {% liquid
                case request.locale.iso_code
                  when 'de'
                    echo settings.request_only_success_message_de
                  when 'en'
                    echo settings.request_only_success_message_en
                  when 'it'
                    echo settings.request_only_success_message_it
                  when 'es'
                    echo settings.request_only_success_message_es
                  when 'fr'
                    echo settings.request_only_success_message_fr
                  else
                    echo settings.request_only_success_message_de
                endcase
              %}
            </div>

            <div style="text-align: center; margin-top: 30px;">
              <button type="button" class="button button--primary" data-custom-close>
                {% liquid
                  case request.locale.iso_code
                    when 'de'
                      echo 'Schließen'
                    when 'en'
                      echo 'Close'
                    when 'it'
                      echo 'Chiudi'
                    when 'es'
                      echo 'Cerrar'
                    when 'fr'
                      echo 'Fermer'
                    else
                      echo 'Schließen'
                  endcase
                %}
              </button>
            </div>
          </main>
        </div>
      </div>
    </div>

    <script>
      // Script zum Aktualisieren der Produktinformationen im Request-Only-Formular
      document.addEventListener('DOMContentLoaded', function () {
        // Funktion, um das Request-Only-Formular zu aktualisieren
        function updateRequestOnlyForm(productData) {
          // Prüfen, ob das Modal und die Formulare existieren
          const modal = document.getElementById('modal-request-only');
          if (!modal) return;

          console.log('Aktualisiere Request-Only Formular mit Produktdaten...', productData);

          // Produktdaten in versteckte Felder eintragen
          const productIdField = document.getElementById('requestOnlyForm-product_id');
          const productTitleField = document.getElementById('requestOnlyForm-product_title');
          const productUrlField = document.getElementById('requestOnlyForm-product_url');
          const productSkuField = document.getElementById('requestOnlyForm-product_sku');
          const productPriceField = document.getElementById('requestOnlyForm-product_price');

          if (productIdField && productData.id) {
            productIdField.value = productData.id;
          }
          if (productTitleField && productData.title) {
            productTitleField.value = productData.title;
          }
          if (productUrlField && productData.url) {
            productUrlField.value = window.location.origin + productData.url;
          }
          if (productSkuField && productData.sku) {
            productSkuField.value = productData.sku;
          }
          if (productPriceField && productData.price) {
            productPriceField.value = productData.price;
          }

          // Produktanzeige in der Tabelle aktualisieren
          const displayTitle = document.getElementById('requestOnlyForm-display-title');
          const displaySku = document.getElementById('requestOnlyForm-display-sku');
          const displayPrice = document.getElementById('requestOnlyForm-display-price');

          if (displayTitle && productData.title) {
            displayTitle.textContent = productData.title;
          }
          if (displaySku && productData.sku) {
            displaySku.textContent = productData.sku;
          }
          if (displayPrice && productData.price) {
            // Formatiere den Preis
            const price = parseFloat(productData.price);
            if (!isNaN(price)) {
              const formattedPrice = new Intl.NumberFormat(window.Shopify?.locale || 'de-DE', {
                style: 'currency',
                currency: window.Shopify?.currency?.active || 'EUR',
              }).format(price);
              displayPrice.textContent = formattedPrice;
            } else {
              displayPrice.textContent = productData.price;
            }
          }

          // Nachricht vorausfüllen
          const messageField = document.getElementById('RequestOnlyForm-message');
          if (messageField && productData.title) {
            const locale = document.documentElement.lang || 'de';
            let messageText = `Hallo,\n\nich interessiere mich für das Produkt "${productData.title}"`;
            if (productData.sku) {
              messageText += ` (SKU: ${productData.sku})`;
            }
            messageText += '.\n\nBitte kontaktieren Sie mich für weitere Informationen.\n\nVielen Dank!';

            switch (locale) {
              case 'en':
                messageText = `Hello,\n\nI am interested in the product "${productData.title}"`;
                if (productData.sku) {
                  messageText += ` (SKU: ${productData.sku})`;
                }
                messageText += '.\n\nPlease contact me for more information.\n\nThank you!';
                break;
              case 'it':
                messageText = `Ciao,\n\nsono interessato al prodotto "${productData.title}"`;
                if (productData.sku) {
                  messageText += ` (SKU: ${productData.sku})`;
                }
                messageText += '.\n\nVi prego di contattarmi per ulteriori informazioni.\n\nGrazie!';
                break;
              case 'es':
                messageText = `Hola,\n\nestoy interesado en el producto "${productData.title}"`;
                if (productData.sku) {
                  messageText += ` (SKU: ${productData.sku})`;
                }
                messageText += '.\n\nPor favor contáctenme para más información.\n\n¡Gracias!';
                break;
              case 'fr':
                messageText = `Bonjour,\n\nje suis intéressé par le produit "${productData.title}"`;
                if (productData.sku) {
                  messageText += ` (SKU: ${productData.sku})`;
                }
                messageText += ".\n\nVeuillez me contacter pour plus d'informations.\n\nMerci !";
                break;
            }

            messageField.value = messageText;
          }
        }

        // Globale Funktion für andere Scripts verfügbar machen
        window.updateRequestOnlyForm = updateRequestOnlyForm;

        // Prüfe beim Laden der Seite, ob contact_posted=true in der URL ist
        function checkForContactSuccess() {
          const urlParams = new URLSearchParams(window.location.search);
          const contactPosted = urlParams.get('contact_posted');

          if (contactPosted === 'true') {
            // Zeige Success-Popup
            setTimeout(() => {
              if (typeof MicroModal !== 'undefined') {
                MicroModal.show('modal-request-success');
              }

              // Zeige ehrlichen Hinweis nach dem Success-Popup
              showNoEmailNotice();

              // Entferne den Parameter aus der URL (optional, für saubere URL)
              const newUrl = window.location.pathname + window.location.hash;
              window.history.replaceState({}, document.title, newUrl);
            }, 500); // Kurze Verzögerung für bessere UX
          }
        }

        // Zeige ehrlichen Hinweis im Success-Popup
        function showNoEmailNotice() {
          const successModal = document.getElementById('modal-request-success');
          if (successModal) {
            const modalContent = successModal.querySelector('.modal__content .modal__text');
            if (modalContent) {
              const originalContent = modalContent.innerHTML;
              const noEmailNoticeText = `{% liquid
                case request.locale.iso_code
                  when "de"
                    echo "ℹ️ <strong>Hinweis:</strong><br>Wir haben Ihre Anfrage erhalten. Sie erhalten <strong>keine gesonderte E-Mail</strong>."
                  when "en"
                    echo "ℹ️ <strong>Notice:</strong><br>We have received your inquiry. You will <strong>not receive a separate email</strong>."
                  when "it"
                    echo "ℹ️ <strong>Avviso:</strong><br>Abbiamo ricevuto la vostra richiesta. <strong>Non riceverete un'email separata</strong>."
                  when "es"
                    echo "ℹ️ <strong>Aviso:</strong><br>Hemos recibido su consulta. <strong>No recibirá un email por separado</strong>."
                  when "fr"
                    echo "ℹ️ <strong>Avis:</strong><br>Nous avons reçu votre demande. Vous <strong>ne recevrez pas d'email séparé</strong>."
                  else
                    echo "ℹ️ <strong>Hinweis:</strong><br>Wir haben Ihre Anfrage erhalten. Sie erhalten <strong>keine gesonderte E-Mail</strong>."
                endcase
              %}`;

              const additionalInfo = `
                <div style="margin-top: 20px; padding: 15px; background-color: #f9f9f9; border-left: 4px solid #666; border-radius: 4px;">
                  <p style="margin: 0; font-size: 14px; color: #333;">
                    ${noEmailNoticeText}
                  </p>
                </div>
              `;
              modalContent.innerHTML = originalContent + additionalInfo;
            }
          }
        }

        // Führe die Prüfung beim Laden der Seite aus
        checkForContactSuccess();

        // Einfache Lösung: Kein komplexes Email-System mehr benötigt
        console.log('Request-Only System bereit - ehrlicher Hinweis wird im Success-Popup angezeigt');

        // Reset-Funktion für Modal-Close
        function resetRequestOnlyModal() {
          const form = document.getElementById('requestOnlyForm');
          const successContainer = document.getElementById('requestOnlySuccessContainer');

          if (form) {
            form.style.display = 'block';
            form.reset();
          }
          if (successContainer) {
            successContainer.style.display = 'none';
          }
        }

        // Globale Funktion für andere Scripts verfügbar machen
        window.resetRequestOnlyModal = resetRequestOnlyModal;

        // Event-Listener für Modal-Close
        const modal = document.getElementById('modal-request-only');
        if (modal) {
          modal.addEventListener('click', function (e) {
            if (e.target.hasAttribute('data-custom-close')) {
              resetRequestOnlyModal();
            }
          });
        }
      });
    </script>
  {% endif %}

  {% comment %} Ankündigungs-Pop-Up {% endcomment %}
  {% if settings.announcement_popup_enable %}
    <div
      class="modal micromodal-slide"
      id="modal-announcement"
      aria-hidden="true"
      data-delay="{{ settings.announcement_popup_delay | default: 3 }}"
      data-homepage-only="{{ settings.announcement_popup_homepage_only }}"
      data-start-date="{{ settings.announcement_popup_start_date }}"
      data-end-date="{{ settings.announcement_popup_end_date }}"
    >
      <div class="modal__overlay" tabindex="-1" data-custom-close>
        <div class="modal__container" role="dialog" aria-modal="true" aria-labelledby="modal-announcement-title">
          <button class="modal__close" aria-label="Close modal" data-custom-close>x</button>
          <header class="modal__header">
            <h2 class="modal__title" id="modal-announcement-title">
              {% liquid
                assign current_lang = request.locale.iso_code
                case current_lang
                  when 'de'
                    echo settings.announcement_popup_headline_de
                  when 'en'
                    echo settings.announcement_popup_headline_en
                  when 'es'
                    echo settings.announcement_popup_headline_es
                  when 'it'
                    echo settings.announcement_popup_headline_it
                  when 'fr'
                    echo settings.announcement_popup_headline_fr
                  else
                    echo settings.announcement_popup_headline_de
                endcase
              %}
            </h2>
          </header>
          <main class="modal__content" id="modal-announcement-content">
            <div class="modal__text">
              {% liquid
                assign current_lang = request.locale.iso_code
                case current_lang
                  when 'de'
                    echo settings.announcement_popup_text_de
                  when 'en'
                    echo settings.announcement_popup_text_en
                  when 'es'
                    echo settings.announcement_popup_text_es
                  when 'it'
                    echo settings.announcement_popup_text_it
                  when 'fr'
                    echo settings.announcement_popup_text_fr
                  else
                    echo settings.announcement_popup_text_de
                endcase
              %}
            </div>

            {% liquid
              assign current_lang = request.locale.iso_code
              assign button_label = ''
              assign button_url = ''

              case current_lang
                when 'de'
                  assign button_label = settings.announcement_popup_button_label_de
                  assign button_url = settings.announcement_popup_button_url_de
                when 'en'
                  assign button_label = settings.announcement_popup_button_label_en
                  assign button_url = settings.announcement_popup_button_url_en
                when 'es'
                  assign button_label = settings.announcement_popup_button_label_es
                  assign button_url = settings.announcement_popup_button_url_es
                when 'it'
                  assign button_label = settings.announcement_popup_button_label_it
                  assign button_url = settings.announcement_popup_button_url_it
                when 'fr'
                  assign button_label = settings.announcement_popup_button_label_fr
                  assign button_url = settings.announcement_popup_button_url_fr
                else
                  assign button_label = settings.announcement_popup_button_label_de
                  assign button_url = settings.announcement_popup_button_url_de
              endcase
            %}

            {% if button_label != blank and button_url != blank %}
              <div class="modal__actions">
                <a href="{{ button_url }}" class="button button--primary">
                  {{ button_label }}
                </a>
              </div>
            {% endif %}
          </main>
        </div>
      </div>
    </div>
  {% endif %}
</div>
