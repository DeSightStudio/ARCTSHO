class CustomLightbox{constructor(){this.isOpen=!1,this.currentSlide=0,this.totalSlides=0,this.zoomLevel=1,this.maxZoom=10,this.minZoom=.1,this.zoomStep=.1,this.isDragging=!1,this.startX=0,this.startY=0,this.translateX=0,this.translateY=0,this.images=[],this.resolutionCache=new Map,this.currentResolution="base",this.isLoadingResolution=!1,this.zoomThresholds=[1,3,6,10],this.resolutionSizes={base:1600,medium:2400,high:3200,ultra:null},this.zoomDebounceTimer=null,this.zoomDebounceDelay=150,this.lastZoomTime=0,this.zoomChangeThreshold=.5,this.init()}init(){this.createLightboxHTML(),this.disableShopifyLightbox(),this.setupEventListeners(),this.bindTriggers()}isProductImage(e){let t=e.className.toLowerCase();return!["icon","logo","svg-wrapper","loading-spinner"].some(e=>t.includes(e))&&!!e.closest(".product, .product-form, .product-media-modal, .media-gallery, [data-product-id]")}disableShopifyLightbox(){document.querySelectorAll("product-modal").forEach(e=>{e.style.display="none",e.setAttribute("aria-hidden","true")}),document.querySelectorAll("modal-opener").forEach(e=>{e.setAttribute("data-custom-lightbox","true");let t=e.querySelector("img[data-media-id], img");t&&this.isProductImage(t)&&e.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),this.openFromProductImage(t)},!0)})}createLightboxHTML(){document.body.insertAdjacentHTML("beforeend",`
      <div id="custom-lightbox" class="custom-lightbox">
        <div class="custom-lightbox__backdrop">
          <div class="custom-lightbox__container">
            <!-- Close Button -->
            <button type="button" class="custom-lightbox__close" aria-label="Close lightbox">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </button>

            <!-- Main Image Container -->
            <div class="custom-lightbox__image-container">
              <div class="custom-lightbox__image-wrapper">
                <!-- Images will be dynamically inserted here -->
              </div>

              <!-- Navigation Arrows -->
              <button type="button" class="custom-lightbox__nav custom-lightbox__nav--prev" aria-label="Previous image">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                  <path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>
              <button type="button" class="custom-lightbox__nav custom-lightbox__nav--next" aria-label="Next image">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                  <path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </button>
            </div>

            <!-- Bottom Controls Bar -->
            <div class="custom-lightbox__controls">
              <!-- Image Counter -->
              <div class="custom-lightbox__counter">
                <span class="current-slide">1</span> / <span class="total-slides">1</span>
              </div>

              <!-- Zoom Controls -->
              <div class="custom-lightbox__zoom-controls">
                <button type="button" class="custom-lightbox__zoom-btn custom-lightbox__zoom-out" aria-label="Zoom out">−</button>
                <button type="button" class="custom-lightbox__zoom-btn custom-lightbox__zoom-in" aria-label="Zoom in">+</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    `),this.lightbox=document.getElementById("custom-lightbox"),this.backdrop=this.lightbox.querySelector(".custom-lightbox__backdrop"),this.closeBtn=this.lightbox.querySelector(".custom-lightbox__close"),this.imageWrapper=this.lightbox.querySelector(".custom-lightbox__image-wrapper"),this.prevBtn=this.lightbox.querySelector(".custom-lightbox__nav--prev"),this.nextBtn=this.lightbox.querySelector(".custom-lightbox__nav--next"),this.currentSlideEl=this.lightbox.querySelector(".current-slide"),this.totalSlidesEl=this.lightbox.querySelector(".total-slides"),this.zoomInBtn=this.lightbox.querySelector(".custom-lightbox__zoom-in"),this.zoomOutBtn=this.lightbox.querySelector(".custom-lightbox__zoom-out"),this.imageContainer=this.lightbox.querySelector(".custom-lightbox__image-container")}setupEventListeners(){this.closeBtn.addEventListener("click",()=>this.close()),this.backdrop.addEventListener("click",e=>{e.target===this.backdrop&&this.close()}),this.prevBtn.addEventListener("click",()=>this.previousSlide()),this.nextBtn.addEventListener("click",()=>this.nextSlide()),this.zoomInBtn.addEventListener("click",()=>this.zoomIn()),this.zoomOutBtn.addEventListener("click",()=>this.zoomOut()),this.keydownHandler=e=>this.handleKeydown(e),this.imageContainer.addEventListener("wheel",e=>this.handleWheel(e)),this.setupDragSupport()}bindTriggers(){document.addEventListener("click",e=>{var t;e.target.closest('modal-opener[data-custom-lightbox="true"]')||(t=e.target.closest("img[data-media-id], .product__media img, .product-media img, .media img, [data-lightbox-trigger]"))&&this.isProductImage(t)&&(e.preventDefault(),e.stopPropagation(),this.openFromProductImage(t))})}openFromProductImage(e){var t=(e.closest(".product, .product-form, .product-media-modal, .media-gallery, [data-product-id]")||document).querySelectorAll("img[data-media-id], .product__media img, .product-media img, .media img, [data-lightbox-trigger]"),t=Array.from(t).filter(e=>this.isProductImage(e)),t=(console.log("Found product images:",t.length),this.images=t.map((e,t)=>{var o=e.src||e.dataset.src,i=this.getHighResImageUrl(o);return console.log(`Image ${t}:`,{original:o,highRes:i,alt:e.alt,mediaId:e.dataset.mediaId}),{src:i,originalSrc:o,alt:e.alt||"",mediaId:e.dataset.mediaId||null}}),t.indexOf(e));console.log("Clicked image index:",t),this.open(0<=t?t:0)}getHighResImageUrl(t){if(t&&t.includes("shopify")){console.log("Original src:",t);try{let e=t;if(e=e.replace(/(_\d+x\d*|_\d*x\d+|_compact|_grande|_large|_medium|_small|_thumb|_pico|_icon|_master)(\.|@|$)/,"$2"),console.log("After size removal:",e),e===t)return console.log("No size parameters found, using original URL"),t;if(e.includes("?"))e=e.replace("?","_1600x?");else{var o=e.split(".");if(!(1<o.length))return console.warn("No file extension found, using original URL"),t;var i=o.pop(),s=o.join(".");e=s+"_1600x."+i}return console.log("Final high-res URL:",e),e}catch(e){return console.error("Error processing Shopify URL:",e),t}}return console.log("Non-Shopify src:",t),t}getImageUrlForResolution(t,o){if(console.log("getImageUrlForResolution called with:",{src:t,resolution:o}),!t||!t.includes("shopify"))return console.log("Non-Shopify URL, returning as-is:",t),t;try{var i=t.replace(/(_\d+x\d*|_\d*x\d+|_compact|_grande|_large|_medium|_small|_thumb|_pico|_icon|_master)(\.|@|$)/,"$2");if(console.log("Clean src after size removal:",i),i===t)return console.log("No size parameters found in URL, using original"),t;if("ultra"===o)return console.log("Ultra resolution, returning clean src:",i),i;var s=this.resolutionSizes[o];if(console.log("Resolution size mapping:",{resolution:o,size:s}),!s)return console.log("No size found for resolution, returning original:",t),t;let e;if(i.includes("?"))e=i.replace("?",`_${s}x?`);else{var l=i.split(".");if(!(1<l.length))return console.warn("No file extension found, returning original URL"),t;var r=l.pop(),a=l.join(".");e=a+`_${s}x.`+r}return console.log("Final URL for resolution:",e),e}catch(e){return console.error("Error processing URL for resolution:",e),t}}getOptimalResolution(e){return 6<=e?"high":3<=e?"medium":"base"}async loadHigherResolution(l){if(!this.isLoadingResolution&&this.images[this.currentSlide]){var e=this.images[this.currentSlide];let s=this.currentSlide+"-"+l;if(this.resolutionCache.has(s))this.swapImageResolution(this.resolutionCache.get(s),l);else{this.isLoadingResolution=!0,this.showLoadingIndicator();try{let o=this.getImageUrlForResolution(e.src,l),i=new Image;await new Promise((e,t)=>{i.onload=()=>{this.resolutionCache.set(s,o),e()},i.onerror=()=>{console.warn(`Failed to load ${l} resolution for image `+this.currentSlide),t(new Error("Image load failed"))},i.src=o}),this.swapImageResolution(o,l)}catch(e){console.warn("Resolution loading failed:",e)}finally{this.isLoadingResolution=!1,this.hideLoadingIndicator()}}}}swapImageResolution(e,t){let o=this.imageWrapper.querySelector(".custom-lightbox__image");var i;o&&(o.style.transition="opacity 0.2s ease",o.style.opacity="0.8",o.classList.add("loading-resolution"),(i=new Image).onload=()=>{o.src=e,o.style.opacity="1",o.classList.remove("loading-resolution"),this.currentResolution=t,this.updateQualityIndicator(t),setTimeout(()=>{o.style.transition=""},200)},i.src=e)}showLoadingIndicator(){let e=this.lightbox.querySelector(".resolution-loading-indicator");e||((e=document.createElement("div")).className="resolution-loading-indicator",e.innerHTML=`
        <div class="loading-spinner"></div>
        <span>Höhere Auflösung wird geladen...</span>
      `,this.lightbox.appendChild(e)),e.style.display="flex"}hideLoadingIndicator(){var e=this.lightbox.querySelector(".resolution-loading-indicator");e&&(e.style.display="none")}updateQualityIndicator(e){let t=this.lightbox.querySelector(".custom-lightbox__quality-indicator");t||((t=document.createElement("div")).className="custom-lightbox__quality-indicator",this.lightbox.appendChild(t)),t.classList.remove("base","medium","high","ultra"),t.classList.add(e),t.classList.add("show"),setTimeout(()=>{t.classList.remove("show")},2e3)}checkResolutionUpgrade(e){let t=this.getOptimalResolution(e);e=["base","medium","high","ultra"];e.indexOf(this.currentResolution)<e.indexOf(t)&&(clearTimeout(this.zoomDebounceTimer),this.zoomDebounceTimer=setTimeout(()=>{this.loadHigherResolution(t)},this.zoomDebounceDelay))}open(){0!==this.images.length&&(this.currentSlide=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,this.totalSlides=this.images.length,this.isOpen=!0,this.updateSlideContent(),this.updateCounter(),this.updateNavigationVisibility(),this.lightbox.style.display="block",document.body.style.overflow="hidden",document.addEventListener("keydown",this.keydownHandler),requestAnimationFrame(()=>{this.lightbox.classList.add("open")}))}close(){this.isOpen=!1,this.lightbox.classList.remove("open"),document.body.style.overflow="",document.removeEventListener("keydown",this.keydownHandler),setTimeout(()=>{this.lightbox.style.display="none",this.resetZoom(),this.cleanupCache()},300)}cleanupCache(){var e=Array.from(this.resolutionCache.keys());let o={};e.forEach(e=>{var t=parseInt(e.split("-")[0]);o[t]||(o[t]=[]),o[t].push(e)});e=Object.keys(o).map(Number).sort((e,t)=>t-e);3<e.length&&e.slice(3).forEach(e=>{o[e].forEach(e=>{this.resolutionCache.delete(e)})}),console.log(`Cache cleanup: ${this.resolutionCache.size} items remaining`)}previousSlide(){this.totalSlides<=1||(this.currentSlide=0===this.currentSlide?this.totalSlides-1:this.currentSlide-1,this.updateSlide())}nextSlide(){this.totalSlides<=1||(this.currentSlide=this.currentSlide===this.totalSlides-1?0:this.currentSlide+1,this.updateSlide())}updateSlide(){this.updateSlideContent(),this.updateCounter(),this.resetZoom()}updateSlideContent(){if(console.log("updateSlideContent called, currentSlide:",this.currentSlide),console.log("Available images:",this.images),this.images[this.currentSlide]){let e=this.images[this.currentSlide],t=(console.log("Current image data:",e),this.currentResolution="base",this.getHighResImageUrl(e.src));console.log("Initial src for lightbox:",t);var i=this.currentSlide+"-base",i=(this.resolutionCache.set(i,t),document.createElement("div"));i.className="custom-lightbox__slide active";let o=document.createElement("img");o.src=t,o.alt=e.alt,o.className="custom-lightbox__image",o.loading="lazy",o.onerror=()=>{console.error("Failed to load high-res image:",t),e.originalSrc&&t!==e.originalSrc?(console.log("Trying fallback to original URL:",e.originalSrc),o.src=e.originalSrc):console.error("No fallback available for image")},o.onload=()=>{console.log("Successfully loaded image:",o.src)},i.appendChild(o),this.imageWrapper.innerHTML="",this.imageWrapper.appendChild(i),setTimeout(()=>{this.preloadNextResolution()},500)}else console.error("No image found for slide:",this.currentSlide)}async preloadNextResolution(){if(this.images[this.currentSlide]&&!this.isLoadingResolution){var o=this.images[this.currentSlide];let t=this.currentSlide+"-medium";if(!this.resolutionCache.has(t))try{let e=this.getImageUrlForResolution(o.src,"medium");var i=new Image;i.onload=()=>{this.resolutionCache.set(t,e),console.log("Preloaded medium resolution for slide "+this.currentSlide)},i.onerror=()=>{console.warn("Failed to preload medium resolution for slide "+this.currentSlide)},i.src=e}catch(e){console.warn("Preloading failed:",e)}}}updateCounter(){this.currentSlideEl.textContent=this.currentSlide+1,this.totalSlidesEl.textContent=this.totalSlides}updateNavigationVisibility(){var e=1<this.totalSlides;this.prevBtn.style.display=e?"flex":"none",this.nextBtn.style.display=e?"flex":"none"}zoomIn(){this.zoomLevel<this.maxZoom&&(this.zoomLevel,this.zoomLevel+=this.zoomStep,this.updateImageTransform(),this.updateZoomButtons(),this.checkResolutionUpgrade(this.zoomLevel))}zoomOut(){this.zoomLevel>this.minZoom&&(this.zoomLevel,this.zoomLevel-=this.zoomStep,this.updateImageTransform(),this.updateZoomButtons())}resetZoom(){this.zoomLevel=1,this.translateX=0,this.translateY=0,this.currentResolution="base",this.updateImageTransform(),this.updateZoomButtons(),Array.from(this.resolutionCache.keys()).filter(e=>e.startsWith(this.currentSlide+"-")).forEach(e=>{e.endsWith("-base")||this.resolutionCache.delete(e)})}updateImageTransform(){var e=this.imageWrapper.querySelector(".custom-lightbox__image");e&&(e.style.transform=`scale(${this.zoomLevel}) translate(${this.translateX/this.zoomLevel}px, ${this.translateY/this.zoomLevel}px)`,e.style.cursor=1<this.zoomLevel?"grab":"default")}updateZoomButtons(){this.zoomInBtn.disabled=this.zoomLevel>=this.maxZoom,this.zoomOutBtn.disabled=this.zoomLevel<=this.minZoom}handleKeydown(e){if(this.isOpen)switch(e.key){case"Escape":this.close();break;case"ArrowLeft":e.preventDefault(),this.previousSlide();break;case"ArrowRight":e.preventDefault(),this.nextSlide();break;case"+":case"=":e.preventDefault(),this.zoomIn();break;case"-":e.preventDefault(),this.zoomOut()}}handleWheel(e){var t,o;this.isOpen&&(e.preventDefault(),t=Date.now(),o=this.zoomLevel,e.deltaY<0?this.zoomIn():this.zoomOut(),e=Math.abs(this.zoomLevel-o),o=t-this.lastZoomTime,e>=this.zoomChangeThreshold)&&100<o&&(this.lastZoomTime=t,clearTimeout(this.zoomDebounceTimer),this.zoomDebounceTimer=setTimeout(()=>{this.checkResolutionUpgrade(this.zoomLevel)},this.zoomDebounceDelay))}setupDragSupport(){let t=!1,o,i,s,l;this.imageContainer.addEventListener("mousedown",e=>{this.zoomLevel<=1||(t=!0,o=e.clientX,i=e.clientY,s=this.translateX,l=this.translateY,(e=this.imageWrapper.querySelector(".custom-lightbox__image"))&&(e.style.cursor="grabbing"))}),document.addEventListener("mousemove",e=>{!t||this.zoomLevel<=1||(e.preventDefault(),this.translateX=s+(e.clientX-o),this.translateY=l+(e.clientY-i),this.updateImageTransform())}),document.addEventListener("mouseup",()=>{var e;t&&(t=!1,e=this.imageWrapper.querySelector(".custom-lightbox__image"))&&(e.style.cursor=1<this.zoomLevel?"grab":"default")})}}document.addEventListener("DOMContentLoaded",()=>{new CustomLightbox}),window.CustomLightbox=CustomLightbox;